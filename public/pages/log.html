<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title class="no-print">Uber - Application Logs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <style>
      @media print {
        .no-print {
          display: none !important;
        }
      }
    </style>
  </head>
  <body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto py-8">
      <h1 class="text-3xl font-bold mb-6 text-center no-print">
        Application Logs
      </h1>

      <!-- Filters + Actions -->
      <div
        class="flex flex-wrap justify-between mb-4 gap-2 items-center no-print"
      >
        <div class="flex gap-2 items-center">
          <label for="search" class="font-medium">Search:</label>
          <input
            type="text"
            id="search"
            placeholder="Search logs..."
            class="border rounded px-2 py-1"
          />
        </div>
        <div class="flex gap-2 items-center">
          <label for="date" class="font-medium">Date:</label>
          <input type="date" id="date" class="border rounded px-2 py-1" />
        </div>
        <div class="flex gap-2 items-center">
          <label for="limit" class="font-medium">Logs per page:</label>
          <select id="limit" class="border rounded px-2 py-1">
            <option value="5">5</option>
            <option value="10" selected>10</option>
            <option value="20">20</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="500">500</option>
            <option value="1000">1000</option>
          </select>
        </div>
        <div class="flex gap-2">
          <button
            onclick="fetchLogs()"
            class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
          >
            Refresh
          </button>
          <button
            onclick="window.print()"
            class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
          >
            Print Logs
          </button>
          <button
            onclick="clearAllLogs()"
            class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700"
          >
            Clear All Logs
          </button>
        </div>
      </div>

      <!-- Logs Table -->
      <div class="overflow-x-auto bg-white shadow rounded-lg">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-800 text-white">
            <tr>
              <th class="py-3 px-4 text-left">Timestamp</th>
              <th class="py-3 px-4 text-left">Message</th>
              <th class="py-3 px-4 text-left no-print">Actions</th>
            </tr>
          </thead>
          <tbody
            id="logs-body"
            class="bg-white divide-y divide-gray-200"
          ></tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="flex justify-center mt-6 gap-1" id="pagination"></div>
    </div>

    <script>
      const API_URL = '/api/v1/admin/logs/info';

      // Current state
      let currentPage = 1;
      let limit = 10;
      let search = '';
      let date = '';

      const limitSelect = document.getElementById('limit');
      const searchInput = document.getElementById('search');
      const dateInput = document.getElementById('date');

      limitSelect.value = limit;
      searchInput.value = search;

      if (!date) {
        const today = new Date();
        date = today.toISOString().split('T')[0];
      }
      dateInput.value = date;

      // Debounce search
      let searchTimeout;
      const debounceDelay = 300;
      searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          search = searchInput.value.trim();
          currentPage = 1;
          fetchLogs();
        }, debounceDelay);
      });

      limitSelect.addEventListener('change', () => {
        limit = parseInt(limitSelect.value);
        currentPage = 1;
        fetchLogs();
      });

      dateInput.addEventListener('change', () => {
        date = dateInput.value;
        currentPage = 1;
        fetchLogs();
      });

      // Fetch logs
      async function fetchLogs() {
        try {
          const url = new URL(API_URL, window.location.origin);
          url.searchParams.set('page', currentPage);
          url.searchParams.set('limit', limit);
          if (search) url.searchParams.set('search', search);
          if (date) url.searchParams.set('timestamp', date);

          url.searchParams.set('no_logger', '1');

          const res = await fetch(url.toString());
          const json = await res.json();

          if (!json.success)
            throw new Error(json.message || 'Failed to fetch logs');

          const logs = json.logs || json.data || [];
          const meta = json.meta?.pagination || { page: 1, totalPages: 1 };

          const tbody = document.getElementById('logs-body');
          tbody.innerHTML = '';

          logs.forEach(log => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            tr.innerHTML = `
              <td class="py-2 px-4 font-mono text-sm">${moment(log.timestamp).fromNow()}</td>
              <td class="py-2 px-4 break-words">${log.message.replace(/&/g, '&amp;')}</td>
              <td class="py-2 px-4 no-print">
                <button
                  class="bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700"
                  onclick="deleteLog('${log.id}')"
                >
                  Delete
                </button>
              </td>
            `;
            tbody.appendChild(tr);
          });

          renderPagination(meta);
        } catch (err) {
          document.body.innerHTML = `<div class="p-4 text-red-600">${err.message}</div>`;
        }
      }

      // Delete single log
      async function deleteLog(logId) {
        if (!confirm('Are you sure you want to delete this log?')) return;

        try {
          const res = await fetch(
            `/api/v1/admin/logs/info/${logId}/delete?no_logger=1`,
            {
              method: 'DELETE',
            },
          );
          const json = await res.json();

          if (!json.success)
            throw new Error(json.message || 'Failed to delete log');

          fetchLogs();
        } catch (err) {
          alert(`Error: ${err.message}`);
        }
      }

      // Clear all logs
      async function clearAllLogs() {
        if (!confirm('Are you sure you want to clear all logs?')) return;

        try {
          const res = await fetch('/api/v1/admin/logs/info/clear?no_logger=1', {
            method: 'DELETE',
          });
          const json = await res.json();

          if (!json.success)
            throw new Error(json.message || 'Failed to clear logs');

          fetchLogs();
        } catch (err) {
          alert(`Error: ${err.message}`);
        }
      }

      // Pagination
      function renderPagination(meta) {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';

        const createBtn = (text, page, disabled = false, active = false) => {
          const btn = document.createElement('button');
          btn.textContent = text;
          btn.disabled = disabled;
          btn.className = `
            px-3 py-1 rounded
            ${active ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300'}
            ${disabled ? 'bg-gray-300 cursor-not-allowed' : ''}
          `;
          btn.onclick = () => {
            currentPage = page;
            fetchLogs();
          };
          return btn;
        };

        pagination.appendChild(createBtn('«', 1, meta.page === 1));
        pagination.appendChild(createBtn('‹', meta.page - 1, meta.page === 1));

        const start = Math.max(1, meta.page - 2);
        const end = Math.min(meta.totalPages, meta.page + 2);
        for (let i = start; i <= end; i++) {
          pagination.appendChild(createBtn(i, i, false, i === meta.page));
        }

        pagination.appendChild(
          createBtn('›', meta.page + 1, meta.page === meta.totalPages),
        );
        pagination.appendChild(
          createBtn('»', meta.totalPages, meta.page === meta.totalPages),
        );
      }

      // Initial load
      fetchLogs();
    </script>
  </body>
</html>
